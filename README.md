# OpenAI Realtime Agents – SST v3 Monorepo

This repository contains a full-stack monorepo that packages the original **Realtime API Agents Demo** Next.js application inside an [SST v3](https://sst.dev/) deployment for AWS. The goal is to keep the existing product experience intact while adding reproducible infrastructure, multi-stage configuration, and first-class CI/CD.

## Requirements

- Node.js **20.17.0** (see [`.nvmrc`](./.nvmrc))
- [pnpm](https://pnpm.io/) `9.x` (Corepack recommended)
- AWS account with permissions to assume a deployment role via GitHub Actions OIDC

## Repository Layout

```
.
├─ infra/                     # SST v3 infrastructure helpers (eg. WebStack)
│  └─ web.ts
├─ sst.config.ts              # Root SST configuration that instantiates resources directly
├─ sst-env.d.ts               # Type definitions generated by SST for resource helpers
├─ packages/
│  ├─ shared/                 # Shared utilities & types
│  └─ web/                    # Next.js application (App Router)
├─ env/                       # Stage-specific environment templates
├─ .github/workflows/deploy.yml
├─ MIGRATION_PLAN.md
└─ README.md
```

## Getting Started

1. **Install dependencies**
   ```bash
   corepack enable
   pnpm install
   ```
2. **Bootstrap local env vars**
   ```bash
   cp env/dev.env.example env/.dev.env
   # populate env/.dev.env with valid values (OPENAI_API_KEY is required for API routes)
   ```
3. **Run the Next.js app**
   ```bash
   pnpm dev
   ```
   The site is available at [http://localhost:3000](http://localhost:3000) with hot reload.
4. **Optional – run SST live dev**
   ```bash
   pnpm infra:dev
   ```
   `sst dev` proxies requests through the deployed infrastructure while you iterate locally.

## Infrastructure as Code

- [`sst.config.ts`](./sst.config.ts) is the single entry point that configures the app (`home: "aws"`) and instantiates resources directly with SST v3.
- `infra/web.ts` encapsulates the Next.js deployment (`sst.aws.Nextjs`) along with CDN tuning, runtime environment, and outputs.
- Stage and region defaults (`dev`, `stg`, `prod` / `ap-southeast-2`) are resolved inside `sst.config.ts`, and can be overridden via CLI flags or env vars (`SST_STAGE`, `AWS_REGION`).
- Secrets such as `OPENAI_API_KEY` are managed with `sst.Secret` and the SST CLI (`sst secret set`) so nothing sensitive is committed.

### Stage Management

| Stage | Purpose |
| --- | --- |
| `dev` | Personal or feature-level validation |
| `stg` | Pre-production smoke testing |
| `prod` | Production traffic |

### Useful Commands

| Command | Description |
| --- | --- |
| `pnpm dev` | Run the Next.js app locally (using `packages/web`). |
| `pnpm build` | Build the Next.js production bundle. |
| `pnpm infra:deploy:dev` | `sst deploy --stage dev` (same for `stg`, `prod`). |
| `pnpm infra:destroy:<stage>` | `sst remove --stage <stage>` teardown. |
| `pnpm infra:outputs -- --stage <stage>` | Print stack outputs (eg. CloudFront URL). |
| `pnpm lint:infra` | ESLint for infrastructure & shared TypeScript utilities. |
| `pnpm format` | Format the repo with Prettier (`pnpm format:check` for CI-style validation). |

## CI/CD

GitHub Actions workflow [`deploy.yml`](.github/workflows/deploy.yml) covers three scenarios:

- **Push to `main`** – Deploys `stg` automatically, then waits for manual approval (via protected `prod` environment) before deploying production.
- **Pull Requests** – Creates a preview stack named `openai-realtime-agents-pr-<number>`, comments the preview URL, and removes the stack when the PR closes.
- **Shared steps** – pnpm install with caching plus AWS credential provisioning via OIDC.

To enable the workflow, configure these repository secrets:

| Secret | Purpose |
| --- | --- |
| `AWS_ROLE_ARN` | IAM role to assume for deployments. |

## Environment & Secrets

| Variable | Scope | Notes |
| --- | --- | --- |
| `OPENAI_API_KEY` | Server runtime | Managed via `sst secret set`. Required for `/api/session` and `/api/responses`. |
| `NEXT_PUBLIC_STAGE` | Client runtime | Defaults to the active SST stage. |
| `LOG_LEVEL` | Server runtime | Controls lambda log verbosity (`info` by default). |

Set per-stage secrets with SST:

```bash
sst secret set OPENAI_API_KEY sk-... --stage dev
sst secret set OPENAI_API_KEY sk-... --stage stg
sst secret set OPENAI_API_KEY sk-... --stage prod
# Optional fallback used by preview stages
sst secret set OPENAI_API_KEY sk-preview-placeholder --fallback
```

## Observability

- Lambda functions emit structured JSON logs (`LOG_LEVEL=info`).
- CloudFront distribution logs (if enabled in your account) capture cache hits/misses.
- Extend with CloudWatch alarms or third-party exporters by adding constructs to `infra/web.ts`.

## Troubleshooting

| Symptom | Fix |
| --- | --- |
| `sst deploy` fails with missing secrets | Verify `sst secret list --stage <stage>` includes `OPENAI_API_KEY`. |
| Preview deployment collides with existing stack | Run `sst remove --stage pr-<number>` from `infra`. |
| pnpm install fails behind a proxy | Manually download pnpm tarball or run `corepack prepare pnpm@9.12.1 --activate` with proxy settings. |

## Original Demo Documentation

The original README content explaining the agentic patterns is still relevant and has been moved to [`packages/web/README.agent-patterns.md`](packages/web/README.agent-patterns.md) for reference.
